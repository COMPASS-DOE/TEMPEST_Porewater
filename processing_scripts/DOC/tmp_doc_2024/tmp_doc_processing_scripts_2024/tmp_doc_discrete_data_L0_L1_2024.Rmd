---
title: "TEMPEST DOC data analysis L0 to L1 (yearly)"
author: "AMP"
date: "`r Sys.Date()`"
output: html_document
---

This file imports files from generates a yearly DOC/TN data file at L1. 
Outputs from this script are:
1) one L1 file per year per sample type (Lysimeter grids, pooled, source waters) steph did already 
2) weighted DOC values of pooled samples for SPE 
3) add in collection level metadata (evacuation dates etc) steph did already 

File naming: SITE_SAMPLETYPE_ORG_ANALYSISTYPE_YEAR_LEVEL.csv 
Include ORG only if applicable 

# set up

```{r setup}
library(tidyverse)

getwd()
```



# one L1 file per year per sample type (Lysimeter grids, pooled, source waters)


### 2024 
```{r read in 2024}

folder_2024 <- "../tmp_doc_2024/tmp_doc_processed_data_2024/"

files_2024 <- list.files(path = folder_2024, pattern = "*.csv", full.names = TRUE)

all_2024 <- bind_rows(lapply(files_2024, 
                             function(file){
                               read_csv(file) %>%
                                 mutate(file_name = basename(file))
                             }))

View(all_2024)
```

```{r clean and export}
clean_2024 <- all_2024 %>%
  mutate(plot = case_when(plot == "FW" ~ "Freshwater",
                          plot == "C" ~ "Control",
                          plot == "SW" ~ "Saltwater",
                          TRUE ~ plot)) %>%
  #cleaning dates and times: 
    mutate(date = lubridate::as_date(as.character(date), format = "%Y%m%d"),
           evacuation_date = lubridate::as_date(as.character(Evacuation_date_YYYMMDD), format = "%Y%m%d"),
           collection_date = lubridate::as_date(as.character(Collection_Date_YYYYMMDD), format = "%Y%m%d")) %>%
   mutate(Collection_Start_Time_24hrs = str_replace(Collection_Start_Time_24hrs, '\\d+', function(m) str_pad(m, 4, pad = '0', side = ("left"))),
         Collection_End_Time_24hrs = str_replace(Collection_End_Time_24hrs, '\\d+', function(m) str_pad(m, 4, pad = '0', side = ("left")))) %>%
   #NAs present because some groups have no time recorded at all. Enter in a set time for those:
    group_by(plot, grid, evacuation_date, collection_date) %>%
    mutate(Collection_Start_Time_24hrs = case_when(is.na(Collection_Start_Time_24hrs) ~ "1159", 
                          TRUE ~ Collection_Start_Time_24hrs),
           Collection_End_Time_24hrs = case_when(is.na(Collection_End_Time_24hrs) ~ "1159", 
                          TRUE ~ Collection_End_Time_24hrs)) %>% #if no time recorded in the metadata sheet, fill in with noon
  mutate(Collection_Start_Time_24hrs = strptime(Collection_Start_Time_24hrs, format ="%H%M"),
         Collection_Start_Time_24hrs = strftime(Collection_Start_Time_24hrs, "%H:%M:%S"),
         Collection_End_Time_24hrs = strptime(Collection_End_Time_24hrs, format ="%H%M"),
         Collection_End_Time_24hrs = strftime(Collection_End_Time_24hrs, "%H:%M:%S")) %>%
  ungroup() %>%
    mutate(evacuation_datetime = as.POSIXct(paste(evacuation_date, Collection_Start_Time_24hrs), format = "%Y-%m-%d %H:%M:%S"),
         collection_datetime = as.POSIXct(paste(collection_date, Collection_End_Time_24hrs), format = "%Y-%m-%d %H:%M:%S"),
  elapsed_time = collection_datetime - evacuation_datetime) %>%
  rename(tz = EST_EDT) %>%
  #changing names to match previous years; can revisit this:
  rename(sample_name = Vial_ID,
         doc_mg_l = npoc_mgL,
         tdn_mg_l = tdn_mgL,
         doc_flag = npoc_flag) %>%
  select(date, Project, plot, grid, sample_name, evacuation_datetime, collection_datetime, tz, doc_mg_l, tdn_mg_l, doc_flag, tdn_flag)
  ## Note, talk to steph if we want to include the mM or not of DOC -- keep for ESS-DIVE 
  # Also discuss if we want to code in the "lysimeter empty" flag for samples without DOC concentrations  -
  
write_csv(clean_2024, paste0(folder_2024, "01_TMP_PW_NPOCTDN_2024_L1.csv") )#note this is currently set up so that it writes into the folder youre pulling data from so if you run script more than once it will pull in the old file.

```